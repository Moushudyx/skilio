# 约束与检查点

本文件用于补充行为约束、冲突处理与检查点，作为模块实现与测试验收的基准。

## 技能与文件结构

- 技能名称必须等于技能文件夹名。
- 技能文件夹名必须是合法路径段，不允许包含路径分隔符、非法字符或空白名称。
- `skills/` 为唯一真源，其他来源在此汇聚并以此为准。

## SKILL.md 规范

- 必须存在 `SKILL.md`（大小写兼容）。
- 必须包含 `name` 与 `description` 字段。
  - `description` 可为空字符串，但必须存在。
- `metadata` 可缺省，缺省时返回空对象。
- 解析失败时：
  - 记录到 `skilio-debug.log`（时间、路径、原因）。
  - 本次扫描跳过该技能。

## 删除 / 禁用 / 启用

- **删除**只适用于手动创建的本地技能（非 npm、非子包、非安装来源）。
- **禁用**适用于任何来源，支持对“全部智能体”或“指定智能体”生效。
- **启用**移除对应禁用记录并恢复符号链接。
- 删除后必须清理：
  - `skills/` 中的目录
  - 所有目标智能体/IDE 目录下的符号链接

## 冲突处理

- 同名技能冲突时不替用户做价值判断。
- 默认策略：不覆盖、不删除任何非符号链接的技能目录。
- 删除策略：删除本地技能时仅移入回收站，不进行不可恢复删除。
- `scan` 只处理符号链接：不覆盖真实目录，仅删除失效链接并记录日志。
- `install` 遇到同名冲突默认跳过并记录；不覆盖真实目录。
- `update` 允许覆盖同名技能，但仅对非手动技能生效；
  - 全量更新可删除缺失技能（仅非手动技能）。
  - 非全量更新不删除缺失技能，仅记录警告。
- 如果无法继续（如冲突阻断链接或写入）：
  - 记录 `skilio-debug.log`
  - 报错退出
- debug 日志格式至少包含：时间、技能名、冲突双方路径。

## 路径与符号链接

- Windows 平台使用 `junction` 创建目录链接。
- 建议用户将 `skills/npm-*`、`skills/package-*` 加入 `.gitignore`。
- 创建后必须进行有效性校验：
  - 目标存在
  - 目标为有效技能目录

## 配置读写

- `updateJSONFile` 为浅合并覆盖，等同 `Object.assign`。
- `skillDisabled` 与 `installSources` 由业务模块计算并整体覆盖写入。
- 并发写入不做处理，视为用户操作不当，直接报错。

## installSources 生命周期

- 安装：记录来源与技能列表。
- 启用/禁用：只修改 `skillDisabled`，不改 `installSources`。
- 更新发现技能缺失：执行卸载，并从 `installSources` 与 `skillDisabled` 中移除该技能。

## 扫描与性能

- 不限制最大扫描时间。
- 扫描过程中输出进度（已扫描项与当前目标），避免无响应感知。
