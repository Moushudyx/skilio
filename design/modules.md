# 模块设计

## 公共方法

- listAllDirsByDir 给定文件夹路径，列出文件夹下所有子文件夹
- listAllFilesByDir 给定文件夹路径，列出文件夹下所有子文件
- readSkillByDir 给定文件夹路径，读取 SKILL.md 文件并输出结果（名称、描述、元信息，或是发现错误）
- checkSkillDir 给定技能文件夹路径，检查其是否为有效技能文件夹（包含有效的 skill.md 文件）
- checkSymlink 给定符号链接路径，检查符号链接是否有效
  - 检查符号链接指向的文件夹是否为有效技能文件夹
- createSymlink 给定源路径和目标路径，创建符号链接（考虑 Windows 上使用 junction）
- deleteSymlink 给定符号链接路径，删除符号链接
- getAgentConfigDir 给定智能体/IDE 名称，返回其对应的配置目录路径（或是无需配置，如 OpenClaw 完全不用任何配置）
- guessAgent 给定项目根目录，推测用户使用的智能体/IDE（根据配置目录是否存在进行推测）
  - 调用 listAllDirsByDir 方法检查常见智能体/IDE 的配置目录是否存在
  - 特殊情况是 copilot，需额外检查 `.github/` 目录下是否存在 `copilot-instructions.md` 文件或 `skills/` 文件夹
- readJSONFile 给定文件路径，读取并解析 JSON 文件
  - 用 foreslash 的 tryit 包裹为 error-first 风格
- writeJSONFile 给定文件路径和数据，写入 JSON 文件
- updateJSONFile 给定文件路径和数据，增量更新 JSON 文件（合并已有数据）
- runCommand 给定命令和选项，在子进程中运行 shell 命令并返回结果
- info/subInfo/warn/success/error 日志打印方法

## 配置模块 config

用于读取和修改配置文件 `skills-manager-config.json`

其他所有模块获取、修改配置信息均经过此模块

此模块返回的值**永远**是齐全的（没配置的字段也会有默认值）

| 配置项 | 类型 | 默认值 | 说明 |
| ------ | ---- | ------ | ---- |
| `showPrompt` | `boolean` | `true` | 没有推测出智能体/IDE时，是否显示交互式提示 |
| `scanNpm` | `boolean` | `true` | 是否扫描 `node_modules/` 目录 |
| `scanPackages` | `boolean` | `true` | 是否扫描 `packages/` 目录 |
| `cleanLinks` | `boolean` | `true` | 扫描时是否清理失效的符号链接 |
| `defaultAgents` | `string[]` | `[]` | 默认目标智能体/IDE 列表，没有推测出智能体/IDE时，若此表有值则使用该列表，且**不会显示交互式提示** |
| `skillLinkPrefixNpm` | `string` | `"npm-"` | 技能符号链接的前缀，例如设置为 `"np-"` 后，`some-skill` 技能的符号链接将命名为 `np-some-skill` |
| `skillLinkPrefixPackage` | `string` | `"package-"` | 技能符号链接的前缀，例如设置为 `"pkg-"` 后，`some-skill` 技能的符号链接将命名为 `pkg-some-skill` |
| `skillDisabled` | `Record<string, string[]>` | `{}` | 已删除的技能列表，键为技能名称，值为已删除该技能的智能体/IDE 列表，例如：`{ "some-skill": ["cursor", "copilot"] }` 表示 `some-skill` 技能在 `cursor` 和 `copilot` 智能体/IDE 中已被删除，如果值为空数组则表示该技能在所有智能体/IDE 中已被删除 |
| `installSources` | `Record<string, string[]>` | `[]` | 已安装的技能来源列表，键为技能来源，值为从该来源安装的技能列表，工具会记录通过 `skills-manager install` 指令安装的技能来源 |

### 修改配置

用户指定配置项和值，调用此方法修改配置文件，如果不存在则创建，新创建的配置文件应该只包含需要修改的项

不修改 `skillDisabled`、`installSources` 配置项，该配置项由工具自动维护

## 智能体/IDE 模块 agents

此模块用于识别智能体/IDE，返回其配置目录

- guessAgent 方法依赖此模块
- 此模块内部配置一套已知智能体/IDE 列表，包含名称、配置目录路径、推测依据等信息
- 特殊情况 OpenClaw，无需任何配置目录，技能直接放在项目根目录的 `skills/` 目录下，所以内部直接忽略此智能体/IDE
- 特殊情况 copilot，需额外检查 `.github/` 目录下是否存在 `copilot-instructions.md` 文件或 `skills/` 文件夹

传入项目根目录路径，返回已识别的智能体/IDE 列表

## 扫描模块 scan

用于路径扫描，输入根目录和配置选项，输出技能列表（包括名称、描述、元信息、路径）

### 核心扫描模块

输入路径，扫描路径下所有 `*/skills/` 文件夹

- 仅一层，比如输入路径 `A/` 其下有子文件夹 `B/` 和 `C/`，则扫描 `A/B/skills/` 和 `A/C/skills/` 文件夹，不继续深入扫描 `A/B/D/skills/` 等更深层次的文件夹

进入每个 `skills/` 文件夹，扫描其下所有技能文件夹

进入每个技能文件夹，读取其 `skill.md` 文件（可能存在不同的大小写文件名需要兼容），解析技能名称、描述、元信息

- 若 `skill.md` 文件缺失或无效，则跳过该技能文件夹并记录错误日志

输出技能列表，包含技能名称、描述、元信息、路径等

### 核心扫描模块外壳

用于处理配置选项，调用核心扫描模块

需要处理 `node_modules/`、`packages/` 目录的扫描逻辑

其中 `node_modules/` 目录需要处理命名空间包 `/@XXX/YYY` 的情况

调用核心扫描模块之后，合并所有扫描结果，输出到 `skills/` 目录下（包括创建符号链接）

获取目标智能体/IDE （配置文件、命令行参数、guessAgent 方法猜测），没有获取到的话弹出交互式提示

获取目标智能体/IDE 的配置目录路径（可能存在多个）

扫描配置目录路径，获取已经安装的技能（包括符号链接）

比对扫描结果和已经安装的技能，删除多余的符号链接，创建缺失的符号链接，更新变更的技能符号链接（覆盖同名）

- 创建符号链接前需要读取配置 `skillDisabled`，跳过被禁用的技能（如果是所有智能体/IDE 都禁用的技能，则连 `skills/` 目录下的符号链接也删除）
- 如果出现同名技能冲突，打印错误日志并跳过该 智能体/IDE

## 新增模块 add

读取配置 `skillLinkPrefixNpm` 和 `skillLinkPrefixPackage` 获取符号链接前缀，新增技能的名称前缀不得为这两个前缀之一

在 `skills/` 目录下创建同名技能文件夹，并创建 `SKILL.md` 文件模板

```markdown
---
name: <技能名称>
description: <留空>
metadata:
  author: <留空>
---
```

获取目标智能体/IDE （配置文件、命令行参数、guessAgent 方法猜测），没有获取到的话弹出交互式提示

- 无论如何都应该运行 guessAgent 方法猜测，如果配置文件或命令行参数规定了范围，且某个猜测出来的智能体/IDE 不在配置文件、命令行参数获取的值中，则编辑配置 `skillDisabled` ，将该技能在该智能体/IDE 中标记为禁用

获取目标智能体/IDE 的配置目录路径（可能存在多个）

符号链接上面创建的技能文件夹到所有目标智能体/IDE 的配置目录路径中

- 如果出现同名技能冲突，打印错误日志并跳过该 智能体/IDE

## 删除 del

读取配置 `skillLinkPrefixNpm` 和 `skillLinkPrefixPackage` 获取符号链接前缀，如果技能名称以这两个前缀之一开头，则删除操作改为“禁用”

读取配置 `installSources`，如果技能名称存在于某个来源列表中，则删除操作改为“禁用”

运行 guessAgent 方法猜测，如果配置文件或命令行参数规定了范围，且某个猜测出来的智能体/IDE 不在配置文件、命令行参数获取的值中，则删除操作改为“禁用”

如果是“禁用”操作，则在配置 `skillDisabled` 中将该技能在对应智能体/IDE 中标记为已禁用

如果是“删除”操作，则弹出交互式提示，用户同意后，删除根目录下 `skills/` 目录中的该技能文件夹（放入回收站），然后扫描所有目标智能体/IDE 的配置目录路径，删除对应的符号链接

- 交互时提示改为三个选项：
  - 禁用该技能（不删除根目录下的技能文件夹，只在配置文件中标记为已禁用，删除对应的符号链接）
  - 删除该技能（删除根目录下的技能文件夹，并删除所有智能体/IDE 配置目录中的符号链接）
  - 取消操作

## 列出 list

调用核心扫描模块读取根目录下 `skills/` 目录中的所有技能文件夹，读取其 `SKILL.md` 文件，输出技能名称、描述、元信息等

- 区分手动添加的技能与符号链接
- 禁用的技能读不出来（因为符号链接都没有），如果用户使用 `--show-disabled` 参数，则需要调用配置模块读取配置 `skillDisabled`，列出被禁用的技能，再调用扫描模块找到所有能找到的技能，对于被禁用且还能找到的技能，读取其 `SKILL.md` 文件，输出技能名称、描述、元信息等（需要标注此技能已禁用）

如果指定智能体/IDE，则扫描该智能体/IDE 的配置目录路径，列出该智能体/IDE 已安装的技能（包括手动添加的技能、符号链接）

- 如果制定了多个智能体/IDE，则合并列出所有指定智能体/IDE 的技能，其中需要区分哪个是哪个（可能存在某个技能对 A、B 智能体/IDE 禁用，对 C 智能体/IDE 启用，默认只注明 C 智能体）
  - 如果出现同名技能但是内容（名称、描述、元信息）不一致，则输出信息也要注明
- 禁用的技能同上，但是需要注明是对哪个智能体/IDE 禁用（可能存在某个技能对 A、B 智能体/IDE 禁用，对 C 智能体/IDE 启用，此时需要著名其禁用情况）

## 安装技能 install

读取配置 `installSources` 配置项，如果技能来源已存在则报错退出

分析传入的技能来源，支持以下几种来源格式：

- 默认从 GitHub 安装 `<owner>/<repo>`
- 从 GitHub 指定分支安装分支上的所有技能 `<owner>/<repo>/tree/<branch>`
- 从 GitHub 指定分支安装指定技能 `<owner>/<repo>/tree/<branch>/skills/<skill-name>`
- 指定 git URL 安装，只要该 URL 指向的仓库中包含 `skills/` 目录即可

前三种 GitHub 格式的来源，转换为对应的 git URL（其中指定技能的类型比较特殊，需要单独记录技能名）

使用临时目录克隆对应的 git 仓库

调用核心扫描模块扫描临时目录下的 `skills/` 目录，获取技能列表

- 读取配置 `skillLinkPrefixNpm` 和 `skillLinkPrefixPackage` 获取符号链接前缀，安装技能的名称前缀不得为这两个前缀之一
- 如果是指定技能格式的来源，则只保留该技能，其他技能忽略

比对扫描结果和根目录下 `skills/` 目录中的已有技能，再比对 `installSources` 配置项中已有的技能

- 如果技能名称冲突，发起交互式提示，让用户选择覆盖、跳过、取消操作；默认选择跳过

获取目标智能体/IDE （配置文件、命令行参数、guessAgent 方法猜测），没有获取到的话弹出交互式提示

- 无论如何都应该运行 guessAgent 方法猜测，如果配置文件或命令行参数规定了范围，且某个猜测出来的智能体/IDE 不在配置文件、命令行参数获取的值中，则编辑配置 `skillDisabled` ，将可以安装的技能在该智能体/IDE 中标记为禁用

在 `skills/` 目录下创建下载技能文件夹（从临时目录复制）

创建符号链接到所有目标智能体/IDE 的配置目录路径中

- 如果出现同名技能冲突，打印错误日志并跳过该 智能体/IDE

删除临时目录

### 根据源获取 git 路径模块

根据传入的技能来源字符串，返回对应的 git URL 和分支名称（如果有指定分支的话），以及指定技能名称（如果有指定技能的话）

### 克隆文件到临时目录模块

根据 git URL 和分支名称，克隆对应的 git 仓库到临时目录，返回临时目录路径

- 克隆参数需要注意分支、克隆深度等，操作尽可能小

## 更新技能 update

整体逻辑与安装技能模块基本一致，但是可以

- 只更新指定的已安装的技能
- 只更新指定来源安装的技能

读取配置 `installSources` 配置项，获取已安装的技能来源列表

如果是指定更新已安装的技能，则过滤出包含传入技能的来源列表

- 如果某个技能不存在于任何来源列表中，则报错退出

转换为对应的 git URL（其中指定技能的类型比较特殊，需要单独记录技能名）

- 复用安装技能模块下的子模块

使用临时目录克隆对应的 git 仓库

- 复用安装技能模块下的子模块

调用核心扫描模块扫描临时目录下的 `skills/` 目录，获取技能列表

- 如果用户选择是的“更新指定的已安装的技能”的模式，则过滤出传入的技能列表

对比新旧技能列表，可能发生的情况：

- 技能名称一致，直接覆盖（更新）
- 不再有某个技能，如果用户选择是的“更新指定的已安装的技能”的模式，则报错退出；如果是“更新指定来源安装的技能”的模式或全量更新，则删除该技能（删除根目录下 `skills/` 目录中的该技能文件夹，删除所有智能体/IDE 配置目录中的符号链接）
- 新增了技能，直接安装该技能（安装根目录下 `skills/` 目录中的该技能文件夹，创建所有智能体/IDE 配置目录中的符号链接）

删除临时目录
